<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sysevent_script_action">
    <sysevent_script_action action="INSERT_OR_UPDATE">
        <active>false</active>
        <condition_script>creation_provisioning_status == "ready";</condition_script>
        <description/>
        <event_name>x_1636309_employ_0.okta.user.provision</event_name>
        <name>Call Okta API</name>
        <order>100</order>
        <script><![CDATA[(function executeRule(current, previous /*null when async*/) {

    // Parse the incoming Okta response
    var r = new sn_ws.RESTMessageV2('Okta Integration - NEAR', 'Create Okta User');

    var payload = JSON.stringify({
        firstname: current.variables.first_name.toString(),
        lastname: current.variables.last_name.toString(),
        secondEmail: current.variables.personal_email.toString(),
        department: current.variables.department.toString(),
        branch: current.variables.branch.toString(),
        jobTitle: current.variables.job_title.toString(),
        mobileNumber: current.variables.mobile_number.toString(),
        employee_manager_s_name: current.variables.employee_manager_s_name.toString(),
        requestNumber: current.number.toString()
    });

    r.setRequestBody(payload);
    r.setRequestHeader("Content-Type", "application/json");

    try {
        var response = r.execute();
        var responseBody = response.getBody();
        var httpStatus = response.getStatusCode();

        var responseObj = JSON.parse(responseBody);

        // Extract the Okta response data
        var login = responseObj.profile?.login || '';
        var email = responseObj.profile?.email || '';
        var empNumber = responseObj.profile?.employeeNumber || '';
        var password = responseObj.tempPassword || ''; // if Okta returns it directly
        var comment = responseObj.comment || 'User created successfully in Okta';
        var requestNumber = responseObj.requestNumber || '';

        // Find the specific record in ServiceNow using the request number
        var gr = new GlideRecord('New Employee Access Request');
        if (gr.get('number', requestNumber)) {
            // Update fields with the Okta response data
            gr.company_username = login;
            gr.company_email = email;
            gr.employee_number = empNumber;
            gr.okta_temp_password = password;
            gr.okta_comment = comment;

            gr.okta_status = 'completed';  // Your own process status
            gr.update();

            gs.info('Okta user created: ' + login + ', employee #: ' + empNumber);
        } else {
            gs.error('Request number not found: ' + requestNumber);
        }

    } catch (ex) {
        gs.error('Okta integration failed: ' + ex.message);
    }

})(current, previous);
]]></script>
        <synchronous>false</synchronous>
        <sys_class_name>sysevent_script_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-04-07 03:02:25</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>eac3df70c3b022109518b11ed401314a</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>Call Okta API</sys_name>
        <sys_overrides/>
        <sys_package display_value="New Employee Access Request" source="x_1636309_employ_0">c686c320c30422109518b11ed40131d0</sys_package>
        <sys_policy/>
        <sys_scope display_value="New Employee Access Request">c686c320c30422109518b11ed40131d0</sys_scope>
        <sys_update_name>sysevent_script_action_eac3df70c3b022109518b11ed401314a</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-04-07 18:16:14</sys_updated_on>
    </sysevent_script_action>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>eac3df70c3b022109518b11ed401314a</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-04-07 03:02:25</sys_created_on>
        <sys_id>add45b30c3b022109518b11ed4013172</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-04-07 03:02:25</sys_updated_on>
        <table>sysevent_script_action</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
